name: Update BC Lions Moabit Data

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 10:00 AM UTC (full update)
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Select what to update'
        required: true
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'calendars-only'
        - 'games-only'
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: |
        echo "Running comprehensive test suite..."
        npm test
        echo "All tests passed âœ…"
    
    - name: Determine update type
      id: update_type
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "type=full" >> $GITHUB_OUTPUT
          echo "Update triggered by schedule - running full update"
        else
          echo "type=${{ github.event.inputs.update_type }}" >> $GITHUB_OUTPUT
          echo "Update triggered manually - type: ${{ github.event.inputs.update_type }}"
        fi
      
    - name: Run full build process
      if: steps.update_type.outputs.type == 'full'
      run: |
        echo "ðŸ”„ Starting full build process (games + calendars + HTML)..."
        npm run build
        echo "âœ… Full build process completed"
        
    - name: Run calendars-only build
      if: steps.update_type.outputs.type == 'calendars-only'
      run: |
        echo "ðŸ“… Starting calendars-only build (calendars + HTML)..."
        npm run build:calendars
        echo "âœ… Calendars-only build completed"
        
    - name: Run games-only build
      if: steps.update_type.outputs.type == 'games-only'
      run: |
        echo "ðŸ€ Starting games-only build (games + HTML)..."
        npm run build:games
        echo "âœ… Games-only build completed"
        
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
          git status
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Update termine and spiele, rebuild HTML - $(date '+%Y-%m-%d %H:%M:%S')"
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Summary
      run: |
        echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add update type specific summary
        case "${{ steps.update_type.outputs.type }}" in
          "full")
            echo "### ðŸ”„ Full Update Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ€ Fetched games for all 22 BC Lions Moabit teams" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“… Downloaded 7 training calendars from Google Calendar" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ Downloaded 1 termine calendar" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ Generated all ICS files with parallel processing" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ Rebuilt HTML website" >> $GITHUB_STEP_SUMMARY
            ;;
          "calendars-only")
            echo "### ðŸ“… Calendars-Only Update Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“… Downloaded 7 training calendars from Google Calendar" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ Downloaded 1 termine calendar" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ Generated calendar ICS files" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ Rebuilt HTML website" >> $GITHUB_STEP_SUMMARY
            echo "- âš¡ **Fast**: Skipped games data (450+ API calls saved)" >> $GITHUB_STEP_SUMMARY
            ;;
          "games-only")
            echo "### ðŸ€ Games-Only Update Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ€ Fetched games for all 22 BC Lions Moabit teams" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ Generated games ICS files" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ Rebuilt HTML website" >> $GITHUB_STEP_SUMMARY
            echo "- âš¡ **Fast**: Skipped calendar downloads" >> $GITHUB_STEP_SUMMARY
            ;;
        esac
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Technical Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture**: Modular services with dependency injection" >> $GITHUB_STEP_SUMMARY
        echo "- **Quality**: 279 comprehensive tests ensuring reliability" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered**: ${{ github.event_name == 'schedule' && 'Scheduled (daily at 10:00 UTC)' || 'Manual dispatch' }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.check_changes.outputs.changes }}" == "true" || "${{ github.event.inputs.force_update }}" == "true" ]]; then
          echo "- **Result**: âœ… Changes committed and pushed to repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Result**: â„¹ï¸ No changes detected, repository unchanged" >> $GITHUB_STEP_SUMMARY
        fi